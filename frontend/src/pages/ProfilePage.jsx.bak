import { useEffect, useState } from "react";
import { useAuthStore } from "../store/authStore";
import { fetchMe, updateMe } from "../api/auth";
import { addTeachSkill, removeTeachSkillApi, addLearnSkill, removeLearnSkillApi } from "../api/skills";
import { listMySessions, acceptSession, rejectSession, cancelSession } from "../api/sessions";
import { notifySuccess, notifyError } from "../utils/toast";
import TeachItem from "../components/TeachItem";

export default function ProfilePage() {
  const user = useAuthStore((s) => s.user);
  const setUser = useAuthStore((s) => s.setUser);
  const [editing, setEditing] = useState(false);
  const [form, setForm] = useState({
    name: "",
    avatarUrl: "",
    bio: "",
    github: "",
    linkedin: "",
    demoVideos: [],
    projectFiles: []
  });
  const [loading, setLoading] = useState(false);
  const [showAddSkill, setShowAddSkill] = useState(false);
  const [newSkill, setNewSkill] = useState({ name: "", level: "beginner" });
  const [newVideo, setNewVideo] = useState({ url: "", description: "" });
  const [newFile, setNewFile] = useState({ url: "", description: "" });
  const [sessions, setSessions] = useState([]);
  const [sessionsLoading, setSessionsLoading] = useState(false);

  useEffect(() => {
    if (!user) {
      fetchMe().then(res => { if (res.user) setUser(res.user); }).catch(console.error);
    } else {
      setForm({
        name: user.name || "",
        avatarUrl: user.avatarUrl || "",
        bio: user.bio || "",
        github: user.github || "",
        linkedin: user.linkedin || "",
        demoVideos: user.demoVideos || [],
        projectFiles: user.projectFiles || []
      });
    }
    loadSessions();
  }, [user]);

  async function loadSessions() {
    setSessionsLoading(true);
    try {
      const data = await listMySessions();
      setSessions(data.sessions || []);
    } catch (err) {
      console.error(err);
    } finally {
      setSessionsLoading(false);
    }
  }

  async function handleAccept(sessionId) {
    try {
      await acceptSession(sessionId);
      notifySuccess('Session accepted!');
      await loadSessions();
    } catch (err) {
      notifyError(err.message || 'Failed to accept session');
    }
  }

  async function handleReject(sessionId) {
    try {
      await rejectSession(sessionId);
      notifySuccess('Session rejected!');
      await loadSessions();
    } catch (err) {
      notifyError(err.message || 'Failed to reject session');
    }
  }

  async function handleCancel(sessionId) {
    try {
      await cancelSession(sessionId);
      notifySuccess('Session cancelled!');
      await loadSessions();
    } catch (err) {
      notifyError(err.message || 'Failed to cancel session');
    }
  }

  if (!user) return <div className="p-10">Please login to view profile.</div>;

  async function handleSave(e) {
    e.preventDefault();
    setLoading(true);
    try {
      const res = await updateMe(form);
      if (res.user) {
        setUser(res.user);
        notifySuccess('Profile updated');
        setEditing(false);
      } else {
        notifyError(res.message || 'Could not update profile');
      }
    } catch (err) {
      console.error(err);
      notifyError(err.message || 'Update failed');
    } finally { setLoading(false); }
  }

  const addVideo = () => {
    if (newVideo.url.trim()) {
      setForm(prev => ({
        ...prev,
        demoVideos: [...prev.demoVideos, { url: newVideo.url, description: newVideo.description }]
      }));
      setNewVideo({ url: "", description: "" });
    }
  };

  const addFile = () => {
    if (newFile.url.trim()) {
      setForm(prev => ({
        ...prev,
        projectFiles: [...prev.projectFiles, { url: newFile.url, description: newFile.description }]
      }));
      setNewFile({ url: "", description: "" });
    }
  };

  const handleAddSkill = async (skillType) => {
    if (!newSkill.name.trim()) {
      notifyError("Skill name required");
      return;
    }
    try {
      setLoading(true);
      if (skillType === "teach") {
        await addTeachSkill({ name: newSkill.name, level: newSkill.level });
      } else {
        await addLearnSkill({ name: newSkill.name });
      }
      const updated = await fetchMe();
      setUser(updated);
      setNewSkill({ name: "", level: "beginner" });
      setShowAddSkill(false);
      notifySuccess("Skill added!");
    } catch (e) {
      notifyError(e.message || "Failed to add skill");
    } finally {
      setLoading(false);
    }
  };

  const handleRemoveSkill = async (skillType, skillId) => {
    try {
      setLoading(true);
      if (skillType === "teach") {
        await removeTeachSkillApi(skillId);
      } else {
        await removeLearnSkillApi(skillId);
      }
      const updated = await fetchMe();
      setUser(updated);
      notifySuccess("Skill removed!");
    } catch (e) {
      notifyError(e.message || "Failed to remove skill");
    } finally {
      setLoading(false);
    }
  };

  const profileCompleteness = () => {
    if (!user) return 0;
    let score = 0;
    if (user.name) score += 30;
    if (user.avatarUrl) score += 20;
    if (user.teaches && user.teaches.length > 0) score += 25;
    if (user.learns && user.learns.length > 0) score += 15;
    if (user.badges && user.badges.length > 0) score += 10;
    return Math.min(score, 100);
  };

  return (
    <div className="max-w-4xl mx-auto p-4">
      {/* Instagram-like Header */}
      <div className="flex items-center space-x-6 mb-8">
        <img
          src={user.avatarUrl || `https://api.dicebear.com/7.x/thumbs/svg?seed=${user.name}`} alt="avatar" className="w-32 h-32 rounded-full object-cover border-4 border-white shadow-lg"
        />
        <div className="flex-1">
          <div className="flex items-center space-x-4 mb-4">
            <h1 className="text-2xl font-bold">{user.name}</h1>
            <button onClick={() => setEditing(!editing)} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
              {editing ? 'Cancel' : 'Edit Profile'}
            </button>
          </div>
          <div className="flex space-x-8 mb-4">
            <div><strong>{user.teaches?.length || 0}</strong> skills taught</div>
            <div><strong>{user.learns?.length || 0}</strong> skills learning</div>
            <div><strong>{user.points || 0}</strong> credits</div>
          </div>
          <p className="text-gray-700 mb-2">{user.bio || 'No bio yet.'}</p>
          <div className="flex space-x-4">
            {user.github && <a href={`https://github.com/${user.github}`} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">GitHub</a>}
            {user.linkedin && <a href={`https://linkedin.com/in/${user.linkedin}`} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">LinkedIn</a>}
          </div>
        </div>
      </div>

      {/* Edit Form */}
      {editing && (
        <form onSubmit={handleSave} className="bg-white p-6 rounded-lg shadow-md mb-8">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label className="block">
              <span className="text-sm font-medium">Name</span>
              <input type="text" value={form.name} onChange={(e) => setForm({...form, name: e.target.value})} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm" />
            </label>
            <label className="block">
              <span className="text-sm font-medium">Avatar URL</span>
              <input type="url" value={form.avatarUrl} onChange={(e) => setForm({...form, avatarUrl: e.target.value})} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm" />
            </label>
            <label className="block md:col-span-2">
              <span className="text-sm font-medium">Bio</span>
              <textarea value={form.bio} onChange={(e) => setForm({...form, bio: e.target.value})} rows={3} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm" />
            </label>
            <label className="block">
              <span className="text-sm font-medium">GitHub Username</span>
              <input type="text" value={form.github} onChange={(e) => setForm({...form, github: e.target.value})} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm" />
            </label>
            <label className="block">
              <span className="text-sm font-medium">LinkedIn Username</span>
              <input type="text" value={form.linkedin} onChange={(e) => setForm({...form, linkedin: e.target.value})} className="mt-1 block w-full border-gray-300 rounded-md shadow-sm" />
            </label>
          </div>

          {/* Demo Videos */}
          <div className="mt-6">
            <h3 className="text-lg font-semibold mb-2">Demo Videos</h3>
            <div className="flex space-x-2 mb-2">
              <input type="url" placeholder="Video URL" value={newVideo.url} onChange={(e) => setNewVideo({...newVideo, url: e.target.value})} className="flex-1 border-gray-300 rounded-md shadow-sm" />
              <input type="text" placeholder="Description" value={newVideo.description} onChange={(e) => setNewVideo({...newVideo, description: e.target.value})} className="flex-1 border-gray-300 rounded-md shadow-sm" />
              <button type="button" onClick={addVideo} className="px-4 py-2 bg-green-600 text-white rounded">Add</button>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {form.demoVideos.map((video, index) => (
                <div key={index} className="bg-gray-100 p-4 rounded">
                  <video controls className="w-full h-32 object-cover rounded">
                    <source src={video.url} type="video/mp4" />
                  </video>
                  <p className="mt-2 text-sm">{video.description}</p>
                </div>
              ))}
            </div>
          </div>

          {/* Project Files */}
          <div className="mt-6">
            <h3 className="text-lg font-semibold mb-2">Project Files</h3>
            <div className="flex space-x-2 mb-2">
              <input type="url" placeholder="File URL" value={newFile.url} onChange={(e) => setNewFile({...newFile, url: e.target.value})} className="flex-1 border-gray-300 rounded-md shadow-sm" />
              <input type="text" placeholder="Description" value={newFile.description} onChange={(e) => setNewFile({...newFile, description: e.target.value})} className="flex-1 border-gray-300 rounded-md shadow-sm" />
              <button type="button" onClick={addFile} className="px-4 py-2 bg-green-600 text-white rounded">Add</button>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {form.projectFiles.map((file, index) => (
                <div key={index} className="bg-gray-100 p-4 rounded">
                  <a href={file.url} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">
                    {file.description || 'Project File'}
                  </a>
                </div>
              ))}
            </div>
          </div>

          <button type="submit" disabled={loading} className="mt-6 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
            {loading ? 'Saving...' : 'Save Changes'}
          </button>
        </form>
      )}

      {/* Posts Grid - Demo Videos and Project Files */}
      <div className="grid grid-cols-3 gap-4 mb-8">
        {user.demoVideos?.map((video, index) => (
          <div key={`video-${index}`} className="aspect-square bg-gray-100 rounded-lg overflow-hidden">
            <video controls className="w-full h-full object-cover">
              <source src={video.url} type="video/mp4" />
            </video>
            <p className="p-2 text-xs text-gray-700">{video.description}</p>
          </div>
        ))}
        {user.projectFiles?.map((file, index) => (
          <div key={`file-${index}`} className="aspect-square bg-gray-100 rounded-lg overflow-hidden flex items-center justify-center">
            <a href={file.url} target="_blank" rel="noopener noreferrer" className="text-center p-4">
              <div className="text-4xl mb-2">ðŸ“„</div>
              <p className="text-sm text-blue-600 hover:underline">{file.description || 'Project File'}</p>
            </a>
          </div>
        ))}
      </div>

      <section className="mt-8">
        <div className="flex items-center justify-between mb-3">
          <h2 className="text-xl font-semibold">Teaches (Skills you offer)</h2>
          <button onClick={() => setShowAddSkill(!showAddSkill)} className="px-3 py-1 bg-blue-600 text-white text-sm rounded">
            {showAddSkill ? 'Cancel' : '+ Add skill'}
          </button>
        </div>
        
        {showAddSkill && (
          <div className="bg-white p-4 rounded shadow mb-4 max-w-md">
            <label className="block mb-3">
              <div className="text-sm font-medium">Skill name</div>
              <input value={newSkill.name} onChange={(e) => setNewSkill({...newSkill, name: e.target.value})} className="w-full border px-3 py-2 rounded mt-1" placeholder="e.g., Python" />
            </label>
            <label className="block mb-3">
              <div className="text-sm font-medium">Proficiency level</div>
              <select value={newSkill.level} onChange={(e) => setNewSkill({...newSkill, level: e.target.value})} className="w-full border px-3 py-2 rounded mt-1">
                <option value="beginner">Beginner</option>
                <option value="intermediate">Intermediate</option>
                <option value="expert">Expert</option>
              </select>
            </label>
            <button disabled={loading} onClick={() => handleAddSkill("teach")} className="px-4 py-2 bg-green-600 text-white rounded">
              {loading ? 'Adding...' : 'Add teach skill'}
            </button>
          </div>
        )}

        <div className="grid gap-3">
          {user.teaches && user.teaches.length ? user.teaches.map(t => (
            <div key={t._id} className="flex items-center justify-between bg-white p-4 rounded shadow">
              <div>
                <div className="font-semibold">{t.name}</div>
                <div className="text-xs text-gray-500 capitalize">{t.level}</div>
              </div>
              <button onClick={() => handleRemoveSkill("teach", t._id)} className="px-3 py-1 bg-red-500 text-white text-sm rounded">
                Remove
              </button>
            </div>
          )) : <div className="text-sm text-gray-500">You haven't added any teaching skills yet.</div>}
        </div>
      </section>

      <section className="mt-8">
        <div className="flex items-center justify-between mb-3">
          <h2 className="text-xl font-semibold">Learns (Skills you want to learn)</h2>
          <button onClick={() => setShowAddSkill(!showAddSkill)} className="px-3 py-1 bg-blue-600 text-white text-sm rounded">
            {showAddSkill ? 'Cancel' : '+ Add skill'}
          </button>
        </div>

        {showAddSkill && (
          <div className="bg-white p-4 rounded shadow mb-4 max-w-md">
            <label className="block mb-3">
              <div className="text-sm font-medium">Skill name</div>
              <input value={newSkill.name} onChange={(e) => setNewSkill({...newSkill, name: e.target.value})} className="w-full border px-3 py-2 rounded mt-1" placeholder="e.g., JavaScript" />
            </label>
            <button disabled={loading} onClick={() => handleAddSkill("learn")} className="px-4 py-2 bg-green-600 text-white rounded">
              {loading ? 'Adding...' : 'Add learn skill'}
            </button>
          </div>
        )}

        <div className="grid gap-3">
          {user.learns && user.learns.length ? user.learns.map(l => (
            <div key={l._id} className="flex items-center justify-between bg-white p-4 rounded shadow">
              <div>
                <div className="font-semibold">{l.name}</div>
              </div>
              <button onClick={() => handleRemoveSkill("learn", l._id)} className="px-3 py-1 bg-red-500 text-white text-sm rounded">
                Remove
              </button>
            </div>
          )) : <div className="text-sm text-gray-500">You haven't added any learning skills yet.</div>}
        </div>
      </section>

      <section className="mt-8">
        <h2 className="text-xl font-semibold mb-3">Badges</h2>
        <div className="flex gap-2 flex-wrap">
          {user.badges && user.badges.length ? user.badges.map(b => <div key={b.key} className="px-3 py-1 bg-yellow-100 rounded">{b.title}</div>) : <div className="text-sm text-gray-500">No badges yet.</div>}
        </div>
      </section>

      {/* Requests & Pending Sessions */}
      <section className="mt-8">
        <h2 className="text-xl font-semibold mb-4">Requests & Pending Sessions</h2>

        {sessionsLoading ? (
          <div className="text-center py-4 text-gray-500">Loading requests...</div>
        ) : (
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {/* Incoming Requests (where user is mentor) */}
            <div className="border rounded-lg p-4 bg-blue-50">
              <h3 className="font-semibold text-lg mb-3 text-blue-900">ðŸ“¥ Incoming Requests</h3>
              <div className="space-y-3 max-h-96 overflow-y-auto">
                {sessions.filter(s => s.mentor?._id === user?._id && s.status === 'pending').length ? (
                  sessions.filter(s => s.mentor?._id === user?._id && s.status === 'pending').map(session => (
                    <div key={session._id} className="bg-white p-3 rounded border-l-4 border-blue-500">
                      <div className="flex justify-between items-start mb-2">
                        <div>
                          <div className="font-semibold text-sm">{session.learner?.name || 'Unknown'}</div>
                          <div className="text-xs text-gray-600">Wants to learn: {session.skillName}</div>
                          <div className="text-xs text-gray-500 mt-1">
                            ðŸ“… {new Date(session.scheduledAt).toLocaleDateString()} {new Date(session.scheduledAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                          </div>
                        </div>
                        <span className="px-2 py-1 bg-yellow-200 text-yellow-800 text-xs rounded">Pending</span>
                      </div>
                      <div className="flex gap-2 mt-3">
                        <button onClick={() => handleAccept(session._id)} className="flex-1 px-2 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700">
                          âœ“ Accept
                        </button>
                        <button onClick={() => handleReject(session._id)} className="flex-1 px-2 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                          âœ• Reject
                        </button>
                      </div>
                    </div>
                  ))
                ) : (
                  <div className="text-sm text-gray-600 text-center py-4">No incoming requests</div>
                )}
              </div>
            </div>

            {/* Outgoing Requests (where user is learner) */}
            <div className="border rounded-lg p-4 bg-green-50">
              <h3 className="font-semibold text-lg mb-3 text-green-900">ðŸ“¤ Sent Requests</h3>
              <div className="space-y-3 max-h-96 overflow-y-auto">
                {sessions.filter(s => s.learner?._id === user?._id && s.status === 'pending').length ? (
                  sessions.filter(s => s.learner?._id === user?._id && s.status === 'pending').map(session => (
                    <div key={session._id} className="bg-white p-3 rounded border-l-4 border-green-500">
                      <div className="flex justify-between items-start mb-2">
                        <div>
                          <div className="font-semibold text-sm">{session.mentor?.name || 'Unknown'}</div>
                          <div className="text-xs text-gray-600">Teaching: {session.skillName}</div>
                          <div className="text-xs text-gray-500 mt-1">
                            ðŸ“… {new Date(session.scheduledAt).toLocaleDateString()} {new Date(session.scheduledAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                          </div>
                          <div className="text-xs text-gray-600 mt-1">ðŸ’° Cost: {session.creditsCost} points</div>
                        </div>
                        <span className="px-2 py-1 bg-yellow-200 text-yellow-800 text-xs rounded">Pending</span>
                      </div>
                      <button onClick={() => handleCancel(session._id)} className="w-full px-2 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700 mt-3">
                        Cancel Request
                      </button>
                    </div>
                  ))
                ) : (
                  <div className="text-sm text-gray-600 text-center py-4">No pending requests</div>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Active & Accepted Sessions */}
        {sessions.filter(s => s.status === 'accepted' || s.status === 'scheduled' || s.status === 'confirmed').length > 0 && (
          <div className="mt-6 border rounded-lg p-4 bg-purple-50">
            <h3 className="font-semibold text-lg mb-3 text-purple-900">âœ… Active Sessions</h3>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-3 max-h-96 overflow-y-auto">
              {sessions.filter(s => s.status === 'accepted' || s.status === 'scheduled' || s.status === 'confirmed').map(session => (
                <div key={session._id} className="bg-white p-3 rounded border-l-4 border-purple-500">
                  <div className="flex justify-between items-start mb-2">
                    <div>
                      <div className="font-semibold text-sm">
                        {session.mentor?._id === user?._id ? session.learner?.name : session.mentor?.name} â€¢ {session.skillName}
                      </div>
                      <div className="text-xs text-gray-600">
                        {session.status === 'scheduled' ? 'ðŸ“… Scheduled' : 'âœ“ Accepted'} â€¢ {session.durationMins}min
                      </div>
                      <div className="text-xs text-gray-500 mt-1">
                        {new Date(session.scheduledAt).toLocaleDateString()} {new Date(session.scheduledAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                      </div>
                      {session.meetingLink && (
                        <a href={session.meetingLink} target="_blank" rel="noopener noreferrer" className="text-xs text-blue-600 hover:underline mt-1 block">
                          Join Meeting â†’
                        </a>
                      )}
                    </div>
                    <span className="px-2 py-1 bg-purple-200 text-purple-800 text-xs rounded capitalize">{session.status}</span>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Completed & Rejected Sessions Summary */}
        <div className="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4">
          <div className="bg-gray-100 p-3 rounded text-center">
            <div className="text-2xl font-bold text-gray-800">{sessions.filter(s => s.status === 'completed').length}</div>
            <div className="text-xs text-gray-600">Completed</div>
          </div>
          <div className="bg-red-100 p-3 rounded text-center">
            <div className="text-2xl font-bold text-red-800">{sessions.filter(s => s.status === 'rejected').length}</div>
            <div className="text-xs text-red-600">Rejected</div>
          </div>
          <div className="bg-orange-100 p-3 rounded text-center">
            <div className="text-2xl font-bold text-orange-800">{sessions.filter(s => s.status === 'cancelled').length}</div>
            <div className="text-xs text-orange-600">Cancelled</div>
          </div>
          <div className="bg-blue-100 p-3 rounded text-center">
            <div className="text-2xl font-bold text-blue-800">{sessions.length}</div>
            <div className="text-xs text-blue-600">Total Sessions</div>
          </div>
        </div>
      </section>
    </div>
  );
}
